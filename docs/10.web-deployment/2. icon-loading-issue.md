# Icon Loading Issue - RESOLVED âœ…

**Date:** October 16, 2025  
**Status:** âœ… **RESOLVED**

## Problem
FontAwesome icons were not displaying correctly on the deployed Firebase Hosting site (https://journey-to-citizen.web.app). The browser console showed:

```
Failed to decode downloaded font: https://journey-to-citizen.web.app/assets/__node_modules/.pnpm/@expo+vector...
OTS parsing error: invalid sfntVersion: 1008813135
```

## Root Cause
The Expo Metro bundler was generating extremely long, nested paths for the FontAwesome font files from `node_modules`:
```
/assets/__node_modules/.pnpm/@expo+vector-icons@15.0.2_expo-font@14.0.8_expo@54.0.12_react-native@0.81.4_@babel+core_efbfbb450f94a5cfe1733596a1ca9881/node_modules/@expo/vector-icons/build/vendor/react-native-vector-icons/Fonts/FontAwesome.b06871f281fee6b241d60582ae9369b9.ttf
```

This caused the font file to become corrupted or unreadable when served by Firebase Hosting, resulting in "OTS parsing error: invalid sfntVersion".

## Solution Implemented âœ…

### Step 1: Copy Font to Assets Folder
Copied the FontAwesome font file directly to the project's assets folder:

```bash
cp node_modules/@expo/vector-icons/build/vendor/react-native-vector-icons/Fonts/FontAwesome.ttf \
   apps/frontend/assets/fonts/
```

### Step 2: Update Font Loading
Modified `app/_layout.tsx` to load FontAwesome from the local assets folder instead of from `node_modules`:

```typescript
// Before
const [loaded, error] = useFonts({
  SpaceMono: require('../assets/fonts/SpaceMono-Regular.ttf'),
  ...FontAwesome.font, // This loads from node_modules
});

// After
const [loaded, error] = useFonts({
  SpaceMono: require('../assets/fonts/SpaceMono-Regular.ttf'),
  FontAwesome: require('../assets/fonts/FontAwesome.ttf'), // Load from assets
});
```

### Step 3: Rebuild and Deploy
```bash
pnpm run build:web
firebase deploy --only hosting
```

## Result

### Before Fix
- Font path: `/assets/__node_modules/.pnpm/@expo+vector...very-long-path.../FontAwesome.ttf`
- Size: 162KB (but corrupted)
- Error: OTS parsing error

### After Fix âœ…
- Font path: `/assets/assets/fonts/FontAwesome.b06871f281fee6b241d60582ae9369b9.ttf`
- Size: 162KB (working correctly)
- Status: **Icons displaying correctly!**

## Benefits
1. âœ… **Shorter path** - Simpler, more reliable URL structure
2. âœ… **No corruption** - Font file loads correctly from Firebase Hosting
3. âœ… **Version control** - Font file is now tracked in git
4. âœ… **Faster builds** - No deep node_modules traversal needed
5. âœ… **Cross-platform** - Works on native and web

## Files Changed
1. `apps/frontend/assets/fonts/FontAwesome.ttf` - Added font file
2. `apps/frontend/app/_layout.tsx` - Updated font loading logic

## Testing Confirmed âœ…
- [x] Icons display in tab navigation
- [x] Icons display in buttons (logout, etc.)
- [x] No console errors
- [x] Font loads successfully in Network tab
- [x] Works in both light and dark mode

## Deployment URL
ðŸŒ **https://journey-to-citizen.web.app**

---

## Alternative Solutions Considered

### âŒ Solution 1: CORS Headers
Added CORS headers but didn't fix the corrupted font file issue.

### âŒ Solution 2: CDN Fonts
Would work but adds external dependency and requires internet connection.

### âœ… Solution 3: Copy to Assets (CHOSEN)
Simple, reliable, and keeps everything self-contained.

## Testing Steps

### 1. Check Browser Console
Visit https://journey-to-citizen.web.app and open browser DevTools:
- Look for 404 errors on font files
- Check for CORS errors
- Verify font loading in Network tab

### 2. Verify Font Loading
```javascript
// Run in browser console
document.fonts.ready.then(() => {
  console.log('Fonts loaded:', Array.from(document.fonts.entries()));
});
```

### 3. Check Font File Accessibility
Try accessing the font file directly in browser:
```
https://journey-to-citizen.web.app/assets/__node_modules/.pnpm/@expo+vector-icons@15.0.2_expo-font@14.0.8_expo@54.0.12_react-native@0.81.4_@babel+core_efbfbb450f94a5cfe1733596a1ca9881/node_modules/@expo/vector-icons/build/vendor/react-native-vector-icons/Fonts/FontAwesome.b06871f281fee6b241d60582ae9369b9.ttf
```

## Alternative Solutions

### Solution 1: Use CDN Fonts (Quick Fix)
Replace local FontAwesome with CDN version:

```typescript
// Add to app/_layout.tsx or index.html
<link 
  rel="stylesheet" 
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" 
/>
```

**Pros:** 
- Works immediately
- No build configuration needed
- Better caching across sites

**Cons:**
- Requires internet connection
- External dependency

### Solution 2: Copy Fonts to Static Assets
Create a `metro.config.js` or use `assetBundlePatterns` to copy fonts to a simpler path:

```javascript
// app.config.js
module.exports = {
  expo: {
    assetBundlePatterns: [
      'assets/**/*',
      'node_modules/@expo/vector-icons/build/vendor/react-native-vector-icons/Fonts/*.ttf'
    ]
  }
};
```

### Solution 3: Use @expo/vector-icons Web Build
Install web-specific font loader:

```bash
npx expo install expo-font @expo/vector-icons
```

Update font loading in `_layout.tsx`:
```typescript
import { useFonts } from 'expo-font';
import * as Font from 'expo-font';

const [loaded] = useFonts({
  'FontAwesome': require('@expo/vector-icons/build/vendor/react-native-vector-icons/Fonts/FontAwesome.ttf'),
});
```

### Solution 4: Webpack Bundler (Not Recommended)
Switch to Webpack bundler for web (requires major config changes):
```javascript
// app.config.js
web: {
  bundler: 'webpack', // Instead of 'metro'
}
```

**Note:** This is not recommended as Metro is the default for Expo SDK 50+.

## Recommended Solution

### Step 1: Verify Current State
After the CORS header fix, test the deployed site:
1. Open https://journey-to-citizen.web.app
2. Check browser console for errors
3. Inspect an icon element to see if font is applied

### Step 2: If Still Not Working
Try **Solution 1 (CDN)** as the quickest fix:
1. Add FontAwesome CDN to `app/_layout.tsx` or `index.html`
2. Rebuild and redeploy
3. Verify icons work

### Step 3: Long-term Fix (If Needed)
If CDN is not acceptable, implement **Solution 2**:
1. Configure `assetBundlePatterns` in `app.config.js`
2. Rebuild with `pnpm run build:web`
3. Verify fonts are in simpler path
4. Redeploy

## Checklist

- [x] Add CORS headers for fonts in `firebase.json`
- [x] Redeploy to Firebase Hosting
- [ ] Test icons on deployed site
- [ ] Check browser console for errors
- [ ] Verify font file loads in Network tab
- [ ] If still failing, implement CDN solution
- [ ] Update documentation with final solution

## Additional Resources
- [Expo Fonts Documentation](https://docs.expo.dev/develop/user-interface/fonts/)
- [Firebase Hosting Headers](https://firebase.google.com/docs/hosting/full-config#headers)
- [Font Loading Best Practices](https://web.dev/font-best-practices/)

## Notes
- The font files ARE in the build, so it's likely a path resolution or CORS issue
- Local development works fine because it serves from localhost
- Firebase Hosting may handle long URLs differently than local dev server
- Consider using a font CDN for better performance and reliability
