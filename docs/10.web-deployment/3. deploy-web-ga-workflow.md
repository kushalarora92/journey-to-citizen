# GitHub Actions CI/CD Setup for Web Deployment

**Date:** October 16, 2025  
**Status:** ✅ Configured

## Overview
Automated web deployment to Firebase Hosting via GitHub Actions using manual workflow dispatch. This allows you to trigger deployments from the GitHub UI without running commands locally.

## Workflow File
Location: `.github/workflows/deploy-web.yml`

## Features
- ✅ Manual trigger via GitHub Actions UI (workflow_dispatch)
- ✅ Environment selection (production vs preview)
- ✅ Automated dependency installation with pnpm
- ✅ Web build with Expo
- ✅ Firebase Hosting deployment
- ✅ Preview channel support for testing

## Required GitHub Secrets

### Firebase Environment Variables
Add these secrets in GitHub: **Settings → Secrets and variables → Actions → New repository secret**

1. **EXPO_PUBLIC_FIREBASE_API_KEY**
   - Value: Your Firebase API key
   - Used for: Firebase client SDK initialization

2. **EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN**
   - Value: `<project-id>.firebaseapp.com`
   - Used for: Firebase Authentication

3. **EXPO_PUBLIC_FIREBASE_PROJECT_ID**
   - Value: Your Firebase project ID
   - Used for: Firebase project identification

4. **EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET**
   - Value: `<project-id>.appspot.com`
   - Used for: Firebase Storage

5. **EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID**
   - Value: Your Firebase messaging sender ID
   - Used for: Firebase Cloud Messaging

6. **EXPO_PUBLIC_FIREBASE_APP_ID**
   - Value: Your Firebase app ID
   - Used for: Firebase app identification

7. **EXPO_PUBLIC_FIREBASE_MEASUREMENT_ID**
   - Value: Your Firebase Analytics measurement ID
   - Used for: Firebase Analytics

### Firebase Service Account
8. **FIREBASE_SERVICE_ACCOUNT**
   - Value: JSON service account key
   - Used for: Firebase deployment authentication
   - How to get it:
     ```bash
     # Generate service account key
     firebase init hosting:github
     # OR manually from Firebase Console:
     # Project Settings → Service Accounts → Generate new private key
     ```
   - Copy the entire JSON content as the secret value

9. **FIREBASE_PROJECT_ID**
   - Value: Your Firebase project ID (same as #3)
   - Used for: Firebase CLI deployment target

## Setup Instructions

### Step 1: Get Your Environment Variables
If you don't have them handy, get them from your local `.env` file:

```bash
cd apps/frontend
cat .env
```

### Step 2: Generate Firebase Service Account
```bash
# From project root
firebase login
firebase projects:list  # Verify your project

# Generate service account (interactive setup)
firebase init hosting:github

# This will:
# 1. Ask for your GitHub repo (kushalarora92/journey-to-citizen)
# 2. Generate a service account key
# 3. Add it as a GitHub secret automatically
```

**Alternative (Manual):**
1. Go to [Firebase Console](https://console.firebase.google.com)
2. Select your project
3. Go to **Project Settings → Service Accounts**
4. Click **Generate New Private Key**
5. Download the JSON file
6. Copy its entire contents as the `FIREBASE_SERVICE_ACCOUNT` secret

### Step 3: Add Secrets to GitHub
1. Go to your GitHub repository: https://github.com/kushalarora92/journey-to-citizen
2. Navigate to **Settings → Secrets and variables → Actions**
3. Click **New repository secret** for each secret listed above
4. Paste the values from your local `.env` and the service account JSON

### Step 4: Test the Workflow
1. Go to **Actions** tab in GitHub
2. Select **Deploy Web to Firebase Hosting** workflow
3. Click **Run workflow**
4. Choose environment: `production` or `preview`
5. Click **Run workflow** button
6. Monitor the deployment progress

## Workflow Behavior

### Production Deployment
- Trigger: Select `production` in workflow dispatch
- Deploys to: Main hosting site (`https://journey-to-citizen.web.app`)
- Channel: `live`

### Preview Deployment
- Trigger: Select `preview` in workflow dispatch
- Deploys to: Preview channel (`https://journey-to-citizen--preview-<id>.web.app`)
- Channel: `preview`
- Useful for: Testing changes before production

## Workflow Steps

1. **Checkout code** - Clones the repository
2. **Setup pnpm** - Installs pnpm package manager (v10)
3. **Setup Node.js** - Installs Node.js v20 with pnpm cache
4. **Install dependencies** - Runs `pnpm install --frozen-lockfile`
5. **Create .env file** - Generates `.env` from GitHub secrets
6. **Build web app** - Runs `pnpm run build:web` in `apps/frontend`
7. **Deploy to Firebase Hosting** - Uses Firebase action to deploy

## Build Output
- Build directory: `apps/frontend/web-build`
- Firebase hosting public: `apps/frontend/web-build` (as configured in `firebase.json`)

## Troubleshooting

### Issue: "Missing secrets"
**Solution:** Ensure all required secrets are added in GitHub Settings → Secrets and variables → Actions.

### Issue: "Firebase authentication failed"
**Solution:** 
- Verify `FIREBASE_SERVICE_ACCOUNT` is valid JSON
- Ensure the service account has "Firebase Hosting Admin" role
- Re-generate the service account key if expired

### Issue: "Build failed"
**Solution:**
- Check the build logs in the Actions tab
- Verify dependencies are correct in `package.json`
- Test the build locally: `cd apps/frontend && pnpm run build:web`

### Issue: "Deployment succeeds but site not updated"
**Solution:**
- Check Firebase Hosting dashboard for deployment status
- Clear browser cache or try incognito mode
- Verify `firebase.json` `public` path is correct

## Security Notes

### Service Account Permissions
- The service account only needs **Firebase Hosting Admin** role
- Do not grant broader permissions than necessary
- Rotate keys periodically (every 90 days recommended)

### Environment Variables
- All `EXPO_PUBLIC_*` variables are exposed in the client bundle
- These are **public** Firebase client keys (safe to expose)
- Never add server-side secrets (API keys, database credentials) to `EXPO_PUBLIC_*` variables

### GitHub Secrets
- Secrets are encrypted and only accessible during workflow runs
- GitHub masks secret values in logs
- Never echo or log secret values in workflow steps

## Future Enhancements

### Automatic Deployments
To enable automatic deployments on push to main:

```yaml
on:
  push:
    branches:
      - main
    paths:
      - 'apps/frontend/**'
      - 'packages/**'
      - 'firebase.json'
  workflow_dispatch:
    # ... existing inputs
```

### Pull Request Previews
To create preview deployments for pull requests:

```yaml
on:
  pull_request:
    branches:
      - main
    paths:
      - 'apps/frontend/**'
```

### Notifications
Add Slack/Discord notifications on deployment success/failure:

```yaml
- name: Notify on success
  if: success()
  run: |
    curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
      -H 'Content-Type: application/json' \
      -d '{"text":"✅ Web deployment successful!"}'
```

## Cost Considerations
- GitHub Actions: 2,000 free minutes/month for public repos, 500 for private
- Each deployment takes ~3-5 minutes
- Firebase Hosting: Free tier includes 10 GB storage, 360 MB/day transfer
- Monitor usage in GitHub Settings → Billing

## Monitoring
- **GitHub Actions**: https://github.com/kushalarora92/journey-to-citizen/actions
- **Firebase Hosting**: https://console.firebase.google.com/project/journey-to-citizen/hosting

## References
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Firebase Hosting GitHub Action](https://github.com/FirebaseExtended/action-hosting-deploy)
- [Expo Web Deployment](https://docs.expo.dev/distribution/publishing-websites/)
