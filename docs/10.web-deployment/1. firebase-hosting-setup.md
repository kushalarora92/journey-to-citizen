# Firebase Hosting Deployment Setup

**Date:** October 16, 2025  
**Status:** ‚úÖ Complete

## Overview
Successfully set up and deployed the Journey to Citizen web app to Firebase Hosting using Expo's static export feature.

## Deployment URL
üåê **Production URL:** https://journey-to-citizen.web.app

## Configuration

### 1. Firebase Configuration (`firebase.json`)
Added hosting configuration to the root `firebase.json`:

```json
{
  "hosting": {
    "public": "apps/frontend/web-build",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  },
  "emulators": {
    "hosting": {
      "port": 5000
    }
  }
}
```

**Key Points:**
- `public`: Points to the Expo web build output directory
- `rewrites`: Enables client-side routing (all routes serve `index.html`)
- `emulators.hosting`: Enables local hosting emulator on port 5000

### 2. Build Scripts (`apps/frontend/package.json`)
Added web build script:

```json
{
  "scripts": {
    "build:web": "expo export --platform web --output-dir web-build"
  }
}
```

**Note:** Using `expo export` instead of deprecated `expo export:web` (Webpack-only command).

## Deployment Process

### Quick Deploy
```bash
# From project root
cd apps/frontend
pnpm run build:web
cd ../..
firebase deploy --only hosting
```

### Step-by-Step

1. **Build the web app:**
   ```bash
   cd apps/frontend
   pnpm run build:web
   ```
   - Generates static web files in `apps/frontend/web-build/`
   - Uses Metro bundler (Expo SDK 50+)
   - Includes 14 static routes
   - Bundle size: ~4MB JS + CSS

2. **Deploy to Firebase Hosting:**
   ```bash
   cd ../..
   firebase deploy --only hosting
   ```
   - Uploads files from `apps/frontend/web-build/`
   - Deploys to `https://journey-to-citizen.web.app`

## Features Enabled

### Firebase Services (Web)
‚úÖ Firebase Authentication (email/password)  
‚úÖ Auth persistence (AsyncStorage)  
‚ö†Ô∏è Firebase Analytics (may be blocked by ad blockers/privacy settings)  
‚úÖ Cloud Firestore  
‚úÖ Client-side routing (Expo Router)

### Static Routes Generated
- `/` (index/home)
- `/auth/sign-in`
- `/auth/sign-up`
- `/auth/verify-email`
- `/auth/forgot-password`
- `/profile`
- `/profile-setup`
- `/absences`
- `/(tabs)`
- `/(tabs)/profile`
- `/(tabs)/absences`
- `/modal`
- `/_sitemap`
- `/+not-found`

## Local Testing

### Test with Firebase Emulator
```bash
# Start the hosting emulator
firebase emulators:start --only hosting

# Access at http://localhost:5000
```

### Test with Expo Dev Server
```bash
cd apps/frontend
pnpm run web

# Access at http://localhost:8081
```

## Environment Variables
The web build automatically includes all `EXPO_PUBLIC_*` environment variables from `.env`:

- `EXPO_PUBLIC_FIREBASE_API_KEY`
- `EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN`
- `EXPO_PUBLIC_FIREBASE_PROJECT_ID`
- `EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET`
- `EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID`
- `EXPO_PUBLIC_FIREBASE_APP_ID`
- `EXPO_PUBLIC_FIREBASE_MEASUREMENT_ID`
- `EXPO_PUBLIC_USE_FIREBASE_EMULATOR`

**Security Note:** These are public client keys and safe to include in web builds.

## Build Output

### Bundle Sizes
- **Total JS:** ~4.05 MB (minified)
- **CSS:** ~2.27 KB
- **Total Files:** 19 files
- **Build Time:** ~92 seconds

### Route Size
Each static route HTML: ~21 KB

## Troubleshooting

### Issue: "expo export:web can only be used with Webpack"
**Solution:** Use `expo export --platform web` instead (Expo SDK 50+ uses Metro bundler by default).

### Issue: Routes return 404
**Solution:** Ensure `rewrites` configuration in `firebase.json` redirects all routes to `/index.html` for client-side routing.

### Issue: Firebase Analytics not working
**Cause:** Ad blockers or browser privacy settings may block Analytics.  
**Solution:** Expected behavior on web; Analytics works on native apps.

### Issue: Icons/FontAwesome not displaying
**Symptom:** Icons appear as blank squares or missing glyphs on deployed site. Console shows "OTS parsing error: invalid sfntVersion".

**Cause:** Font files generated with very long nested paths from `node_modules` that become corrupted when served by Firebase Hosting.

**Solution (APPLIED ‚úÖ):** 
1. Copied FontAwesome.ttf to `apps/frontend/assets/fonts/`
2. Updated `app/_layout.tsx` to load font from assets instead of node_modules:
   ```typescript
   const [loaded, error] = useFonts({
     SpaceMono: require('../assets/fonts/SpaceMono-Regular.ttf'),
     FontAwesome: require('../assets/fonts/FontAwesome.ttf'),
   });
   ```
3. Rebuilt and redeployed

**Result:** Icons now display correctly on deployed site. Font path is now `/assets/assets/fonts/FontAwesome.ttf` instead of the long node_modules path.

See `2025-10-16_icon-loading-issue.md` for detailed troubleshooting steps and resolution.

## Next Steps

### Optional Enhancements
1. **Custom Domain:** Add a custom domain in Firebase Console
2. **Performance Monitoring:** Enable Firebase Performance Monitoring for web
3. **PWA Features:** Add service worker and web manifest for offline support
4. **CI/CD:** Automate builds and deployments via GitHub Actions
5. **Preview Channels:** Use Firebase Hosting preview channels for PR reviews

### Monitoring
- **Firebase Console:** https://console.firebase.google.com/project/journey-to-citizen/overview
- **Hosting Dashboard:** https://console.firebase.google.com/project/journey-to-citizen/hosting

## References
- [Expo Static Export](https://docs.expo.dev/distribution/publishing-websites/)
- [Firebase Hosting Documentation](https://firebase.google.com/docs/hosting)
- [Expo Router for Web](https://docs.expo.dev/router/introduction/)
