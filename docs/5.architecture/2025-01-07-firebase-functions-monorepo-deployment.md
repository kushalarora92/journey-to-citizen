# ADR: Firebase Functions Deployment with Monorepo Shared Types

**Date:** January 7, 2025  
**Status:** Implemented  
**Context:** Firebase Cloud Functions deployment from pnpm monorepo

## Problem

Firebase Cloud Functions does **not support monorepos natively**. Specifically:

1. **Firebase Cloud Build doesn't understand pnpm workspace protocol**
   - `workspace:*` dependencies fail during Cloud Build
   - Error: `EUNSUPPORTEDPROTOCOL: Unsupported URL Type "workspace:"`

2. **Cloud Build runs in isolated environment**
   - Only uploads the functions directory
   - Doesn't have access to parent workspace or sibling packages
   - Cannot resolve cross-package dependencies

3. **Need to share types between frontend and backend**
   - Types package: `packages/types`
   - Used by: `apps/frontend` and `apps/functions/functions`
   - Must keep types synchronized

## Decision

Implement a **predeploy copy strategy** that bundles shared types into the functions directory before deployment.

### Solution Architecture

```
packages/types/          ← Source of truth
  ├── src/
  └── lib/              ← Built output

apps/functions/functions/
  ├── src/
  ├── types/            ← Copied before deploy (gitignored)
  ├── copy-types.js     ← Copy script
  └── package.json      ← Uses "file:./types"
```

### Implementation

**1. Predeploy Script** (`firebase.json`):
```json
"predeploy": [
  "cd packages/types && pnpm build",           // Build types
  "pnpm --prefix \"$RESOURCE_DIR\" run copy-types",  // Copy to functions
  "pnpm --prefix \"$RESOURCE_DIR\" run lint",
  "pnpm --prefix \"$RESOURCE_DIR\" run build"
]
```

**2. Copy Script** (`apps/functions/functions/copy-types.js`):
- Copies `packages/types/lib/*` → `apps/functions/functions/types/`
- Copies `packages/types/package.json`
- Runs before every deployment

**3. Package Dependency** (`apps/functions/functions/package.json`):
```json
{
  "dependencies": {
    "@journey-to-citizen/types": "file:./types"  // Not workspace:*
  }
}
```

**4. Gitignore** (`apps/functions/functions/.gitignore`):
```
types/  # Generated by predeploy, don't commit
```

**5. ESLint Ignore** (`apps/functions/functions/.eslintignore`):
```
types/**        # Skip copied types
copy-types.js   # Skip copy script
```

## Consequences

### Positive
✅ **Keeps shared types** - DRY principle maintained  
✅ **Works with Firebase Cloud Build** - No workspace protocol issues  
✅ **Automatic deployment** - Predeploy handles everything  
✅ **Clean git history** - Generated files ignored  
✅ **Type safety** - Frontend and backend use same types

### Negative
⚠️ **Extra build step** - Copies types on every deploy  
⚠️ **Hidden dependency** - types/ folder not obvious it's generated  
⚠️ **Deploy-time only** - Local development still uses workspace protocol

### Trade-offs
- **Complexity**: Medium - requires copy script and predeploy configuration
- **Performance**: Minimal - copy takes <1 second
- **Maintainability**: Good - well documented and automated

## Alternatives Considered

### 1. Inline Types (Rejected)
Copy-paste types into functions code
- ❌ Violates DRY
- ❌ Types drift between frontend/backend
- ❌ Hard to maintain

### 2. Separate npm Package (Rejected)
Publish types to npm registry
- ❌ Overhead of publishing
- ❌ Version management complexity
- ❌ Not suitable for private project

### 3. Git Submodules (Rejected)
Use git submodules for types
- ❌ Git submodule complexity
- ❌ Still doesn't solve Cloud Build issue
- ❌ Overkill for single shared package

### 4. Firebase Emulator Only (Rejected)
Only use emulator, never deploy
- ❌ Can't test in production
- ❌ Can't use for real users
- ❌ Not a real solution

## Migration Notes

**Before this change:**
- Functions used `workspace:*` dependency
- Deployment failed with protocol error
- Could only run in emulator

**After this change:**
- Functions use `file:./types` dependency
- Predeploy copies built types
- Deployment succeeds ✅

## Files Modified

### New Files
- `apps/functions/functions/copy-types.js` - Copy script
- `apps/functions/functions/.eslintignore` - Ignore types/

### Modified Files
- `firebase.json` - Added predeploy steps
- `apps/functions/functions/package.json` - Changed dependency to `file:./types`
- `apps/functions/functions/.gitignore` - Added `types/`

## Usage

**Deploy functions:**
```bash
firebase deploy --only functions
```

The predeploy script automatically:
1. Builds types package
2. Copies to functions directory
3. Runs lint & build
4. Deploys to Cloud Functions

**Local development:**
```bash
# Types still work via workspace protocol
pnpm --filter functions dev
```

## Future Improvements

If Firebase adds monorepo support:
- [ ] Remove copy-types.js script
- [ ] Remove predeploy copy step
- [ ] Change back to `workspace:*` dependency
- [ ] Remove types/ from gitignore

## References

- [Firebase Functions Best Practices](https://firebase.google.com/docs/functions/best-practices)
- [pnpm Workspace Protocol](https://pnpm.io/workspaces#workspace-protocol-workspace)
- GitHub Issue: Firebase doesn't support monorepos natively
