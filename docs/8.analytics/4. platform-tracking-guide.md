# Platform Tracking Guide

Comprehensive guide on how analytics works across Web, iOS, and Android platforms.

---

## Quick Answers

### ✅ Will it work straightaway for mobile and web?

**YES!** The analytics implementation is fully cross-platform and will work immediately on:
- **Web** (via Firebase JS SDK)
- **iOS** (via React Native Firebase)
- **Android** (via React Native Firebase)

### ✅ Can you distinguish platforms in Firebase Console?

**YES!** We automatically include platform information with every event:
- Built-in Firebase platform detection (Stream, App version, Device info)
- **Custom platform parameters** we add to every event:
  - `platform`: `'web'`, `'ios'`, or `'android'`
  - `platform_version`: OS version string

---

## How It Works

### Cross-Platform Architecture

```
┌─────────────────────────────────────────────────┐
│          useAnalytics Hook (Unified API)        │
└─────────────────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
    ┌──────┐      ┌──────┐        ┌──────────┐
    │ Web  │      │ iOS  │        │ Android  │
    └──────┘      └──────┘        └──────────┘
        │               │               │
        ▼               ▼               ▼
┌──────────────┐ ┌──────────────────────────────┐
│ Firebase JS  │ │  React Native Firebase SDK   │
│     SDK      │ │   (@react-native-firebase)   │
└──────────────┘ └──────────────────────────────┘
        │               │               │
        └───────────────┼───────────────┘
                        ▼
            ┌───────────────────────┐
            │  Firebase Analytics   │
            │       Console         │
            └───────────────────────┘
```

### Platform Detection Logic

**File:** `apps/frontend/hooks/useAnalytics.ts`

```typescript
// Automatically detects platform and routes to correct SDK
if (Platform.OS === 'web' && webAnalytics) {
  // Use Firebase JS SDK
  webLogEvent(webAnalytics, eventName, enrichedParams);
} else if (nativeAnalytics) {
  // Use React Native Firebase (iOS/Android)
  nativeAnalytics.logEvent(eventName, enrichedParams);
}
```

### Automatic Platform Parameters

Every event automatically includes:

```typescript
const enrichedParams = {
  ...params,              // Your custom parameters
  platform: Platform.OS,  // 'web', 'ios', or 'android'
  platform_version: Platform.Version?.toString() || 'unknown',
};
```

**Example Event:**
```javascript
{
  event_name: 'absences_action',
  action: 'add_trip_attempt',
  has_destination: true,
  from_date: '2025-01-15',
  to_date: '2025-01-20',
  platform: 'ios',              // ← Automatically added
  platform_version: '17.0',     // ← Automatically added
}
```

---

## Firebase Console: Platform Filtering

### Built-in Platform Dimensions

Firebase Analytics automatically tracks:

1. **Stream Name** 
   - Web stream vs App stream (iOS/Android)
   
2. **Platform**
   - iOS
   - Android
   - Web
   
3. **App Version**
   - Different for each platform
   
4. **Device Category**
   - Mobile
   - Desktop
   - Tablet

### Custom Platform Filtering

With our implementation, you can filter by:

#### Method 1: Use Built-in Filters
1. Go to Firebase Console → Analytics → Events
2. Click on any event
3. Use **"Platform"** dropdown in filters
4. Select: iOS, Android, or Web

#### Method 2: Use Custom Parameters
1. Go to Firebase Console → Analytics → Events
2. Click on event → **"View parameter details"**
3. Filter by `platform` parameter: `web`, `ios`, or `android`
4. Filter by `platform_version` for OS-specific issues

---

## Viewing Analytics by Platform

### Example Queries

#### 1. All Events by Platform
```
Firebase Console → Analytics → Events
├─ Filter: Platform = "iOS"
└─ Shows: All iOS events
```

#### 2. Specific Event by Platform
```
Firebase Console → Analytics → Events
├─ Select Event: "absences_action"
├─ Filter: platform (parameter) = "web"
└─ Shows: Only web users adding trips
```

#### 3. Conversion Funnel by Platform
```
Firebase Console → Analytics → Analysis → Funnel Analysis
├─ Step 1: sign_up (platform = ios)
├─ Step 2: Profile Setup (platform = ios)
└─ Step 3: add_trip_success (platform = ios)
Shows: iOS user journey completion rate
```

#### 4. Platform Comparison
```
Firebase Console → Analytics → Dashboard
├─ Active Users widget
└─ Breakdown by: Platform
Shows: 60% web, 25% iOS, 15% Android
```

---

## Platform-Specific Implementation Details

### Web (Firebase JS SDK)

**Package:** `firebase@12.3.0`

**Initialization:** `config/firebase.ts`
```typescript
import { getAnalytics, isSupported } from 'firebase/analytics';

if (Platform.OS === 'web') {
  isSupported().then(supported => {
    if (supported) {
      analytics = getAnalytics(app);
    }
  });
}
```

**Events:**
- `logEvent(analytics, eventName, params)`
- Includes `page_location`, `page_path` for page views

**Environment:**
- Requires `EXPO_PUBLIC_FIREBASE_MEASUREMENT_ID`
- Works in browser (Chrome, Safari, Firefox, Edge)

### iOS (React Native Firebase)

**Package:** `@react-native-firebase/analytics@23.4.1`

**Initialization:** Automatic (via `google-services.json`)

**Events:**
- `analytics().logEvent(eventName, params)`
- `analytics().logScreenView({ screen_name, screen_class })`

**Setup Required:**
1. Add `GoogleService-Info.plist` to iOS project
2. Run `npx pod-install` (done automatically by Expo)
3. Build iOS app

**Testing:**
```bash
# Enable debug mode
-FIRDebugEnabled

# View in Xcode console
```

### Android (React Native Firebase)

**Package:** `@react-native-firebase/analytics@23.4.1`

**Initialization:** Automatic (via `google-services.json`)

**Events:**
- `analytics().logEvent(eventName, params)`
- `analytics().logScreenView({ screen_name, screen_class })`

**Setup Required:**
1. Add `google-services.json` to Android project
2. Build Android app

**Testing:**
```bash
# Enable debug mode
adb shell setprop debug.firebase.analytics.app com.kushalarora.journeytocitizen

# View logs
adb logcat | grep "FA"
```

---

## Testing Platform Detection

### 1. Test Web
```bash
cd apps/frontend
pnpm web
```
1. Open browser: http://localhost:8081
2. Perform actions (sign up, add trip, etc.)
3. Check Firebase Console → Analytics → DebugView
4. Verify events show `platform: 'web'`

### 2. Test iOS
```bash
cd apps/frontend
pnpm ios
```
1. App opens in iOS Simulator
2. Perform actions
3. Check Firebase Console → Analytics → DebugView
4. Verify events show `platform: 'ios'`

### 3. Test Android
```bash
cd apps/frontend
pnpm android
```
1. App opens in Android Emulator
2. Perform actions
3. Check Firebase Console → Analytics → DebugView
4. Verify events show `platform: 'android'`

---

## Common Platform Insights

### What to Track by Platform

#### Engagement Comparison
```
Question: Which platform has highest engagement?
Metric: Average session duration by platform
Filter: Platform = iOS vs Android vs Web
```

#### Feature Adoption
```
Question: Do mobile users add more trips than web users?
Metric: Count of 'add_trip_success' events
Breakdown: By platform parameter
```

#### Error Rates
```
Question: Which platform has most errors?
Metric: Count of '*_error' events
Breakdown: By platform
```

#### Conversion Funnel
```
Question: Where do users drop off on each platform?
Analysis: Funnel (sign_up → profile_setup → add_trip)
Comparison: iOS vs Android vs Web
```

---

## Platform-Specific Considerations

### Web
✅ **Advantages:**
- Instant updates (no app store approval)
- Easier debugging (browser DevTools)
- Works on any device with browser

⚠️ **Considerations:**
- Analytics blocked by ad blockers (5-15% of users)
- Need cookie consent in some regions
- May have incomplete sessions if user closes tab

### iOS
✅ **Advantages:**
- More complete session tracking
- Higher user engagement typically
- Better offline support

⚠️ **Considerations:**
- App Store review process for updates
- Requires physical device or simulator for testing
- Limited to Apple devices

### Android
✅ **Advantages:**
- Wide device compatibility
- Google Play console integration
- Faster review process than iOS

⚠️ **Considerations:**
- Device fragmentation (many OS versions)
- Varied screen sizes to support
- Some users have analytics disabled

---

## Best Practices

### 1. Always Test on All Platforms
```bash
# Before deploying
npm run test:web
npm run test:ios
npm run test:android
```

### 2. Monitor Platform-Specific Issues
Set up alerts for:
- High error rates on specific platform
- Unusual drop in platform usage
- Platform-specific crashes

### 3. Use Platform Data for Prioritization
```
Example: If 70% users are on web, prioritize web UX improvements
```

### 4. Create Platform-Specific Reports
```
Weekly Report:
├─ iOS: 1,000 active users, 2% error rate
├─ Android: 500 active users, 1.5% error rate
└─ Web: 3,000 active users, 3% error rate (ad blockers?)
```

---

## Troubleshooting

### Issue: Events not showing for a platform

**Web:**
```bash
# Check browser console
# Look for: "Analytics isSupported: false" or errors
```

**iOS:**
```bash
# Check GoogleService-Info.plist is present
ls -la apps/frontend/ios/journeytocitizen/GoogleService-Info.plist
```

**Android:**
```bash
# Check google-services.json is present
ls -la apps/frontend/android/app/google-services.json
```

### Issue: Can't filter by platform in Firebase Console

1. Wait 24 hours for data processing
2. Check if events have `platform` parameter
3. Go to Firebase Console → Analytics → Events → [Event] → Parameters
4. Register `platform` as a custom dimension if needed

### Issue: Platform showing as 'unknown'

This is normal for the first few events. Firebase needs:
- At least 10 events
- 24 hour processing time
- Sufficient user volume

---

## Summary

✅ **Works out of the box** on Web, iOS, and Android  
✅ **Automatic platform detection** via `Platform.OS`  
✅ **Firebase Console has built-in platform filters**  
✅ **Custom `platform` and `platform_version` parameters** on every event  
✅ **No additional configuration needed** - just use `trackEvent()`  

You can immediately see which platform your users are on and how they behave differently!
