# iOS Firebase Build Fix (Expo SDK 54)

## Problem

iOS production builds failed during pod installation with Firebase Swift pods.

**Initial Error:**
```
[!] The following Swift pods cannot yet be integrated as static libraries:

The Swift pod `FirebaseAuth` depends upon `FirebaseAuthInterop`, 
`FirebaseAppCheckInterop`, `FirebaseCore`, `FirebaseCoreExtension`, 
`GoogleUtilities`, and `RecaptchaInterop`, which do not define modules.

The Swift pod `FirebaseCoreInternal` depends upon `GoogleUtilities`, 
which does not define modules.

Error: Unknown error. See logs of the Install pods build phase for more information.
```

**Secondary Error (after adding `useFrameworks: 'static'`):**
```
include of non-modular header inside framework module 'RNFBApp.RCTConvert_FIRApp':
.../ios/Pods/Headers/Public/React-Core/React/RCTConvert.h
```

## Root Cause

- Firebase iOS SDK v9+ requires `use_frameworks!` with static linkage
- Firebase Swift pods need modular headers for their dependencies
- React Native headers are not modular, causing conflicts with static frameworks
- Expo SDK 54 (React Native 0.81.4) + @react-native-firebase v23.4.1 incompatibility

## Attempted Solutions

### ❌ 1. Custom Expo Plugin with `use_modular_headers!`
- **Result:** Failed at "Read app config" phase in EAS Build
- Plugin didn't execute at the right time in EAS environment

### ❌ 2. EAS Build Hook (eas-build-pre-install.js)
- **Result:** Hook timing didn't work with Podfile generation
- Couldn't modify Podfile before pod install

### ❌ 3. `useFrameworks: 'static'` Only
- **Result:** Same non-modular header errors
- React Native headers incompatible with static frameworks

### ❌ 4. `useFrameworks: 'dynamic'`
- **Result:** Conflict with Firebase static binaries
```
The 'Pods-JourneytoCitizen' target has transitive dependencies that include 
statically linked binaries: FirebaseAnalytics.xcframework
```

### ❌ 5. Custom Plugin with `CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES`
- **Result:** Build failed before reaching pod install (lockfile version mismatch)
- Not recommended by maintainers (removes modularity safety)

### ❌ 6. `forceStaticLinking` with Specific Pods
- **Result:** Not tested (succeeded with simpler solution first)
- Would require maintaining list of all Firebase + dependency pods

## ✅ Final Solution

Use `buildReactNativeFromSource: true` in `expo-build-properties`:

```javascript
// apps/frontend/app.config.js
plugins: [
  'expo-router',
  '@react-native-firebase/app',
  [
    'expo-build-properties',
    {
      ios: {
        useFrameworks: 'static',
        buildReactNativeFromSource: true,
      },
    },
  ],
],
```

**What it does:**
- Builds React Native from source instead of using prebuilt binaries
- Makes React Native headers properly modular
- Compatible with Firebase static frameworks

**Trade-off:**
- Slightly slower iOS builds (~2-3 minutes longer)
- Officially supported by Expo team

## References

- **Primary Source:** [Expo Issue #39607 - Comment by @kitten](https://github.com/expo/expo/issues/39607#issuecomment-2347456547)
- Related: [React Native Firebase Issue #8657](https://github.com/invertase/react-native-firebase/issues/8657)
- Expo Docs: [expo-build-properties](https://docs.expo.dev/versions/latest/sdk/build-properties/)

## Additional Changes

1. **Updated Expo version:** `~54.0.12` → `~54.0.23` (to match lockfile)
2. **Added dependency:** `expo-build-properties@^1.0.9`
3. **Formatted eas.json:** Added iOS build configurations for all profiles

## Status

✅ **Android production build:** Working  
✅ **iOS production build:** Working (Build #12 succeeded)

Date: November 8, 2025
