# EAS Build Setup - Complete Guide

**Date:** October 15, 2025  
**Status:** ✅ Complete

## Table of Contents
1. [What is EAS Build and Why We're Using It](#what-is-eas-build)
2. [Initial Setup](#initial-setup)
3. [Firebase Configuration Files](#firebase-configuration-files)
4. [Environment Variables](#environment-variables)
5. [Monorepo Package Building](#monorepo-package-building)
6. [Build Profiles](#build-profiles)
7. [App Configuration](#app-configuration)
8. [NPM Scripts](#npm-scripts)
9. [Testing and Validation](#testing-and-validation)

---

## What is EAS Build and Why We're Using It

**EAS Build** (Expo Application Services Build) is a cloud-based build service for React Native apps.

### Why We're Using EAS Build

1. **No Local Requirements**: Build iOS apps without needing a Mac or Xcode
2. **Consistent Environment**: Same build environment every time, avoiding "works on my machine" issues
3. **Cloud Infrastructure**: Faster builds with powerful cloud machines
4. **Team Collaboration**: Easily share builds with team members and testers
5. **Credential Management**: Automatic handling of signing certificates and provisioning profiles
6. **CI/CD Ready**: Easy integration with continuous deployment workflows

### Key Problems It Solved for Us

- **Xcode Version Issue**: Local Xcode was too old (14.2 vs required 15.1+)
- **Native Config Files**: Automatic handling of `google-services.json` and `GoogleService-Info.plist`
- **Build Consistency**: Same results across different developer machines
- **Monorepo Support**: Proper handling of workspace dependencies

---

## Initial Setup

### 1. Create EAS Account and Link Project

```bash
# Install EAS CLI globally (if not already installed)
npm install -g eas-cli

# Login to EAS
eas login

# Initialize EAS in your project
cd apps/frontend
eas init --id YOUR_EAS_PROJECT_ID
```

**Project Details:**
- **EAS Project ID**: `YOUR_EAS_PROJECT_ID` (from EAS website or `eas init`)
- **Owner**: `your-eas-account-name`
- **Project Slug**: `your-project-slug`

### 2. Created `eas.json` Configuration

```jsonc
{
  "cli": {
    "version": ">= 16.23.0",
    "appVersionSource": "remote"
  },
  "build": {
    "development": {
      "developmentClient": true,
      "distribution": "internal",
      "env": {
        "GOOGLE_SERVICES_JSON": "@GOOGLE_SERVICES_JSON",
        "GOOGLE_SERVICE_INFO_PLIST": "@GOOGLE_SERVICE_INFO_PLIST"
      }
    },
    "preview": {
      "distribution": "internal",
      "env": {
        "GOOGLE_SERVICES_JSON": "@GOOGLE_SERVICES_JSON",
        "GOOGLE_SERVICE_INFO_PLIST": "@GOOGLE_SERVICE_INFO_PLIST"
      }
    },
    "production": {
      "autoIncrement": true,
      "env": {
        "GOOGLE_SERVICES_JSON": "@GOOGLE_SERVICES_JSON",
        "GOOGLE_SERVICE_INFO_PLIST": "@GOOGLE_SERVICE_INFO_PLIST"
      }
    }
  },
  "submit": {
    "production": {}
  }
}
```

---

## Firebase Configuration Files

### The Problem

Firebase native config files (`google-services.json` for Android, `GoogleService-Info.plist` for iOS) are in `.gitignore` and can't be uploaded to EAS Build servers.

### The Solution: EAS Secrets

EAS Secrets allow you to securely upload files that aren't in version control.

### Upload Config Files

```bash
cd apps/frontend

# Upload Android config
eas secret:create --scope project --name GOOGLE_SERVICES_JSON --type file --value ./google-services.json

# Upload iOS config
eas secret:create --scope project --name GOOGLE_SERVICE_INFO_PLIST --type file --value ./GoogleService-Info.plist
```

**Note**: The command shows as deprecated, but still works. The newer `eas env:create` command doesn't support file uploads yet.

### How It Works

1. Files are uploaded as encrypted secrets to EAS
2. During build, EAS makes them available as environment variables
3. `app.config.js` reads these environment variables and places files in correct locations
4. The Firebase plugin processes them during native build

---

## Environment Variables

### Firebase Web Configuration

We need to pass Firebase web config to the app at build time.

### Upload All Environment Variables

```bash
cd apps/frontend

# Replace YOUR_* placeholders with actual values from Firebase Console
# All commands in one block - copy and paste:
eas env:create --name EXPO_PUBLIC_FIREBASE_API_KEY --value "YOUR_FIREBASE_API_KEY" --scope project --environment preview --environment production --visibility plaintext --non-interactive

eas env:create --name EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN --value "YOUR_PROJECT_ID.firebaseapp.com" --scope project --environment preview --environment production --visibility plaintext --non-interactive

eas env:create --name EXPO_PUBLIC_FIREBASE_PROJECT_ID --value "YOUR_PROJECT_ID" --scope project --environment preview --environment production --visibility plaintext --non-interactive

eas env:create --name EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET --value "YOUR_PROJECT_ID.firebasestorage.app" --scope project --environment preview --environment production --visibility plaintext --non-interactive

eas env:create --name EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID --value "YOUR_SENDER_ID" --scope project --environment preview --environment production --visibility plaintext --non-interactive

eas env:create --name EXPO_PUBLIC_FIREBASE_APP_ID --value "YOUR_APP_ID" --scope project --environment preview --environment production --visibility plaintext --non-interactive

eas env:create --name EXPO_PUBLIC_FIREBASE_MEASUREMENT_ID --value "YOUR_MEASUREMENT_ID" --scope project --environment preview --environment production --visibility plaintext --non-interactive

eas env:create --name EXPO_PUBLIC_USE_FIREBASE_EMULATOR --value "false" --scope project --environment preview --environment production --visibility plaintext --non-interactive
```

> **Note**: Get these values from your Firebase Console → Project Settings → General → Your apps → Web app configuration

### Why `plaintext` Visibility?

Firebase config values are **public** by design - they're bundled in the app and visible to anyone who downloads it. Firebase security is handled by Firestore rules, not by hiding these values.

### View All Environment Variables

```bash
eas env:list
```

---

## Monorepo Package Building

### The Problem

Our monorepo has local packages (`@journey-to-citizen/types`, `@journey-to-citizen/ui`) that need to be compiled from TypeScript to JavaScript before the app can be built.

**Error we encountered:**
```
Error: While trying to resolve module `@journey-to-citizen/types` from file `/home/expo/workingdir/build/apps/frontend/app/(tabs)/profile.tsx`, 
the package `/home/expo/workingdir/build/apps/frontend/node_modules/@journey-to-citizen/types/package.json` was successfully found. 
However, this package itself specifies a `main` module field that could not be resolved 
(`/home/expo/workingdir/build/apps/frontend/node_modules/@journey-to-citizen/types/lib/index.js`
```

### Why `workspace:*` Isn't Enough

The `"workspace:*"` in package.json tells pnpm to **link** local packages, but it doesn't **build** them. The TypeScript source files need to be compiled to JavaScript.

### The Solution: `postinstall` Hook

Added a `postinstall` script to `apps/frontend/package.json`:

```json
{
  "scripts": {
    "postinstall": "cd ../.. && pnpm --filter '@journey-to-citizen/*' --filter '!journey-to-citizen-frontend' build"
  }
}
```

### How It Works

1. **EAS Build Process:**
   - Detects monorepo by finding `pnpm-workspace.yaml`
   - Uploads entire workspace (not just `apps/frontend`)
   - Runs `pnpm install` at workspace root
   - Installs all dependencies including `turbo`
   - Runs `postinstall` hook in frontend package

2. **postinstall Script:**
   - Changes to workspace root: `cd ../..`
   - Uses pnpm filter to build all `@journey-to-citizen/*` packages
   - Excludes the frontend itself: `!journey-to-citizen-frontend`
   - Each package runs its `build` script (TypeScript compilation)

3. **Result:**
   - `packages/types/lib/index.js` ✅ Created
   - `packages/ui/lib/index.js` ✅ Created
   - Metro bundler can now resolve module imports

### Why This Approach is Scalable

- ✅ **No hardcoding**: Automatically builds ALL `@journey-to-citizen/*` packages
- ✅ **Future-proof**: New packages are built automatically
- ✅ **Works locally and on EAS**: Same process everywhere
- ✅ **Uses pnpm's native filtering**: Fast and reliable

### Testing the postinstall Hook

```bash
# Clean built packages
rm -rf ../../packages/*/lib

# Test postinstall
pnpm install

# Verify files were created
ls ../../packages/types/lib/
ls ../../packages/ui/lib/
```

---

## Build Profiles

We have three build profiles (environments) configured in `eas.json`:

### 1. **Development**
```jsonc
"development": {
  "developmentClient": true,
  "distribution": "internal"
}
```
- For development builds with Expo Dev Client
- Includes developer tools and hot reload
- Not used for production releases

### 2. **Preview** (Testing/QA)
```jsonc
"preview": {
  "distribution": "internal"
}
```
- For internal testing and QA
- Standalone builds (no dev client)
- Can be distributed to testers via EAS Submit or direct download
- Does NOT auto-increment version

### 3. **Production**
```jsonc
"production": {
  "autoIncrement": true
}
```
- For App Store / Play Store releases
- Auto-increments build number
- Optimized builds with no debugging tools

### Using Different Profiles

```bash
# Preview build (testing)
eas build --platform android --profile preview

# Production build (release)
eas build --platform android --profile production
```

---

## App Configuration

### app.json vs app.config.js

We have **both** files, but **`app.config.js` supersedes `app.json`**.

**Why?**
- `app.json` is static JSON - can't use environment variables or logic
- `app.config.js` is JavaScript - can read `process.env` and make dynamic decisions
- Expo reads `app.config.js` first if it exists

### Our `app.config.js`

```javascript
module.exports = {
  expo: {
    name: 'Journey to Citizen',
    slug: 'journey-to-citizen',
    version: '1.0.0',
    owner: 'your-eas-account-name',
    extra: {
      eas: {
        projectId: 'YOUR_EAS_PROJECT_ID',
      },
    },
    // ... other static config ...
    ios: {
      bundleIdentifier: 'com.your-app.identifier',
      // Use env var from EAS Secrets, fallback to local file
      googleServicesFile: process.env.GOOGLE_SERVICE_INFO_PLIST || './GoogleService-Info.plist',
    },
    android: {
      package: 'com.your-app.identifier',
      // Use env var from EAS Secrets, fallback to local file
      googleServicesFile: process.env.GOOGLE_SERVICES_JSON || './google-services.json',
    },
    plugins: ['expo-router', '@react-native-firebase/app'],
  },
};
```

### Key Changes Made

1. **Added `owner` field**: Links project to EAS account
2. **Added `extra.eas.projectId`**: Required for EAS Build
3. **Dynamic `googleServicesFile` paths**: Use EAS Secrets during builds, local files during development
4. **Added Firebase plugin**: `@react-native-firebase/app` processes config files

### How Environment Variables Work

- **Local development**: `process.env.GOOGLE_SERVICES_JSON` is undefined → uses local file
- **EAS Build**: EAS sets these env vars → uses secret files
- **Fallback pattern**: `process.env.VAR || './local-file.json'`

---

## NPM Scripts

Added convenient build scripts to `apps/frontend/package.json`:

```json
{
  "scripts": {
    "build:android:preview": "eas build --platform android --profile preview",
    "build:ios:preview": "eas build --platform ios --profile preview",
    "build:android:prod": "eas build --platform android --profile production",
    "build:ios:prod": "eas build --platform ios --profile production"
  }
}
```

### Usage

```bash
cd apps/frontend

# Build Android preview
pnpm run build:android:preview

# Build iOS preview
pnpm run build:ios:preview

# Build Android production
pnpm run build:android:prod

# Build iOS production
pnpm run build:ios:prod
```

---

## Testing and Validation

### 1. Test Monorepo Package Building

```bash
cd apps/frontend

# Clean packages
rm -rf ../../packages/*/lib

# Run install (triggers postinstall)
pnpm install

# Verify built files exist
ls ../../packages/types/lib/
ls ../../packages/ui/lib/
```

**Expected output:**
```
index.d.ts  index.d.ts.map  index.js
Button.d.ts  Button.js  index.d.ts  index.js
```

### 2. First EAS Build Attempt

```bash
eas build --platform android --profile preview
```

**Result:** ✅ Keystore generated, Firebase config files loaded, build in progress

### 3. Verify EAS Secrets

```bash
# List all secrets
eas secret:list

# List all environment variables
eas env:list
```

### 4. Monitor Build Progress

- **Web Dashboard**: https://expo.dev/accounts/kodian-labs/projects/journey-to-citizen/builds
- **Terminal**: Shows real-time progress and logs
- **Build Logs**: Available even after closing terminal

---

## Common Issues and Solutions

### Issue 1: "google-services.json is missing"

**Cause:** Config file not uploaded as EAS Secret

**Solution:**
```bash
eas secret:create --scope project --name GOOGLE_SERVICES_JSON --type file --value ./google-services.json
```

### Issue 2: Module resolution error for `@journey-to-citizen/types`

**Cause:** Monorepo packages not built before bundling

**Solution:** Added `postinstall` hook to build all workspace packages

### Issue 3: "Must specify --visibility flag"

**Cause:** Using `--non-interactive` without `--visibility`

**Solution:** Add `--visibility plaintext` to `eas env:create` commands

### Issue 4: Build works locally but fails on EAS

**Cause:** Environment differences, missing dependencies, or unbuild packages

**Solution:** 
- Ensure `postinstall` hook runs
- Verify all dependencies are in `package.json`
- Check EAS build logs for specific errors

---

## Build Workflow Summary

```
1. Developer runs: eas build --platform android --profile preview
                   ↓
2. EAS CLI uploads workspace to cloud
                   ↓
3. EAS Build server:
   - Detects monorepo structure
   - Runs `pnpm install` at workspace root
   - Installs turbo, all dependencies
                   ↓
4. Runs postinstall hook:
   - Builds @journey-to-citizen/types
   - Builds @journey-to-citizen/ui
                   ↓
5. Loads EAS Secrets:
   - GOOGLE_SERVICES_JSON → google-services.json
   - GOOGLE_SERVICE_INFO_PLIST → GoogleService-Info.plist
   - All EXPO_PUBLIC_* environment variables
                   ↓
6. Runs app.config.js:
   - Reads environment variables
   - Configures Firebase plugin
   - Sets up app metadata
                   ↓
7. Expo prebuild:
   - Generates native Android/iOS projects
   - Applies Firebase plugin
   - Places config files in correct locations
                   ↓
8. Native build:
   - Compiles Java/Kotlin (Android) or Swift/Obj-C (iOS)
   - Links Firebase SDK
   - Bundles JavaScript with Metro
                   ↓
9. Output:
   - APK/AAB (Android) or IPA (iOS)
   - Available for download
   - Can be submitted to stores
```

---

## Next Steps

1. ✅ **Android Preview Build** - In progress
2. ⏳ **Test APK** - Download and verify Firebase Analytics works
3. ⏳ **iOS Preview Build** - Once Android is validated
4. ⏳ **Production Builds** - After testing is complete
5. ⏳ **App Store Submission** - Configure certificates and submit

---

## Resources

- [EAS Build Documentation](https://docs.expo.dev/build/introduction/)
- [EAS Environment Variables](https://docs.expo.dev/build-reference/variables/)
- [EAS Secrets (File Uploads)](https://docs.expo.dev/build-reference/variables/#using-secrets-in-environment-variables)
- [Expo Monorepo Guide](https://docs.expo.dev/guides/monorepos/)
- [Firebase Config Files](https://docs.expo.dev/versions/latest/sdk/firebase-core/)

---

## Conclusion

EAS Build is now fully configured and working for our monorepo setup. Key achievements:

✅ Cloud-based builds without local Xcode requirements  
✅ Secure handling of Firebase config files via EAS Secrets  
✅ All environment variables configured  
✅ Monorepo packages automatically built before bundling  
✅ Multiple build profiles for different environments  
✅ Convenient npm scripts for common build commands  
✅ First Android build successfully initiated  

The setup is scalable, secure, and ready for team collaboration and CI/CD integration.
